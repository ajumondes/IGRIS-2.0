{% extends "base.html" %}
{% block content %}
    <h2>Behavioral Enrollment</h2>
    <p>Please type the following paragraph into the text box below. Your unique typing rhythm will be recorded to create your profile.</p>
    <div class="card bg-light my-3"><div class="card-body fst-italic">
        The quick brown fox jumps over the lazy dog. This sentence contains all letters of the English alphabet. Repetition helps build a more accurate profile. A biometric signature is created from the way you interact with the keyboard.
    </div></div>
    
    <textarea id="enrollmentText" class="form-control" rows="6" placeholder="Start typing here..."></textarea>
    <button id="submitBtn" class="btn btn-primary mt-3">Submit Enrollment Data</button>

    <script>
        const enrollmentText = document.getElementById('enrollmentText');
        const submitBtn = document.getElementById('submitBtn');
        let typingEvents = [];

        enrollmentText.addEventListener('keydown', (event) => {
            if (event.key.length > 1) return; // Ignore control keys
            typingEvents.push({ key: event.key, action: 'keydown', timestamp: event.timeStamp });
        });

        enrollmentText.addEventListener('keyup', (event) => {
            if (event.key.length > 1) return;
            typingEvents.push({ key: event.key, action: 'keyup', timestamp: event.timeStamp });
        });

        submitBtn.addEventListener('click', () => {
            if (typingEvents.length < 50) {
                alert('Please type more to create a reliable profile.');
                return;
            }
            fetch("{{ url_for('api_enroll') }}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(typingEvents)
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                if(data.status === 'success') {
                    window.location.href = "{{ url_for('home') }}";
                }
            })
            .catch(error => console.error('Error:', error));
        });
    </script>
{% endblock %}